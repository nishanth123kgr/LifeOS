// Prisma Schema for LifeOS
// Full-Stack Personal Goal & Life Management System

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== USER & AUTH ==============

model User {
  id                String   @id @default(uuid())
  email             String   @unique
  password          String
  name              String
  age               Int?
  country           String?
  currency          Currency @default(INR)
  monthlyIncome     Float?
  riskPreference    RiskPreference @default(MEDIUM)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relations
  financialGoals    FinancialGoal[]
  fitnessGoals      FitnessGoal[]
  habits            Habit[]
  budgets           Budget[]
  refreshTokens     RefreshToken[]
  preferences       UserPreferences?
  journalEntries    JournalEntry[]
  achievements      UserAchievement[]
  progressSnapshots ProgressSnapshot[]
  budgetTemplate    BudgetTemplate?
  transactions      Transaction[]
  accounts          Account[]

  @@index([email])
  @@map("users")
}

model RefreshToken {
  id          String   @id @default(uuid())
  token       String   @unique
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt   DateTime
  createdAt   DateTime @default(now())

  @@map("refresh_tokens")
}

enum Currency {
  USD
  INR
  EUR
  GBP
}

enum RiskPreference {
  LOW
  MEDIUM
  HIGH
}

// ============== FINANCIAL GOALS ==============

model FinancialGoal {
  id                  String            @id @default(uuid())
  userId              String
  user                User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  name                String
  type                FinancialGoalType
  targetAmount        Float
  currentAmount       Float             @default(0)
  monthlyContribution Float             @default(0)
  startDate           DateTime
  targetDate          DateTime
  status              GoalStatus        @default(ON_TRACK)
  isArchived          Boolean           @default(false)
  isPaused            Boolean           @default(false)
  notes               String?
  createdAt           DateTime          @default(now())
  updatedAt           DateTime          @updatedAt

  // Relations
  budgetAllocations   BudgetItem[]
  transactions        Transaction[]

  @@map("financial_goals")
}

enum FinancialGoalType {
  EMERGENCY_FUND
  MARRIAGE_FUND
  CAR_FUND
  HOME_DOWN_PAYMENT
  INVESTMENTS
  RETIREMENT
  EDUCATION
  VACATION
  CUSTOM
}

enum GoalStatus {
  ON_TRACK
  NEEDS_FOCUS
  BEHIND
  COMPLETED
  PAUSED
  ARCHIVED
}

// ============== FITNESS GOALS ==============

model FitnessGoal {
  id              String          @id @default(uuid())
  userId          String
  user            User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  metricType      FitnessMetricType
  startValue      Float
  currentValue    Float
  targetValue     Float
  unit            String
  startDate       DateTime
  targetDate      DateTime
  status          GoalStatus      @default(ON_TRACK)
  isAchieved      Boolean         @default(false)
  notes           String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt

  // Track progress history
  progressHistory FitnessProgress[]

  @@map("fitness_goals")
}

model FitnessProgress {
  id              String      @id @default(uuid())
  fitnessGoalId   String
  fitnessGoal     FitnessGoal @relation(fields: [fitnessGoalId], references: [id], onDelete: Cascade)
  value           Float
  recordedAt      DateTime    @default(now())
  notes           String?

  @@map("fitness_progress")
}

enum FitnessMetricType {
  WEIGHT
  BODY_FAT
  STEPS
  STRENGTH
  CARDIO
  FLEXIBILITY
  CUSTOM
}

// ============== HABITS ==============

model Habit {
  id            String        @id @default(uuid())
  userId        String
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name          String
  description   String?
  frequency     HabitFrequency
  targetCount   Int           @default(1)  // e.g., 5x per week
  currentStreak Int           @default(0)
  longestStreak Int           @default(0)
  isActive      Boolean       @default(true)
  // Quantity tracking
  isQuantity    Boolean       @default(false)  // true for quantity-based habits
  quantityUnit  String?       // e.g., "glasses", "pages", "minutes"
  quantityTarget Float?       // e.g., 8 glasses, 30 pages
  // Streak freeze
  streakFreezeUsed DateTime?  // Last date streak freeze was used
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Track check-ins
  checkIns      HabitCheckIn[]

  @@index([userId, isActive])
  @@map("habits")
}

model HabitCheckIn {
  id          String   @id @default(uuid())
  habitId     String
  habit       Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  completed   Boolean  @default(true)
  quantity    Float?   // For quantity-based habits
  notes       String?
  skipped     Boolean  @default(false)  // Marked as intentionally skipped
  createdAt   DateTime @default(now())

  @@unique([habitId, date])
  @@index([habitId, date])
  @@map("habit_check_ins")
}

enum HabitFrequency {
  DAILY
  WEEKLY
  WEEKDAYS
  WEEKENDS
  CUSTOM
}

// ============== BUDGET ==============

model Budget {
  id          String       @id @default(uuid())
  userId      String
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  month       Int          // 1-12
  year        Int
  income      Float
  rolloverAmount Float     @default(0)  // Carried over from previous month
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt

  // Budget items
  items       BudgetItem[]

  @@unique([userId, month, year])
  @@index([userId, year, month])
  @@map("budgets")
}

model BudgetItem {
  id            String         @id @default(uuid())
  budgetId      String
  budget        Budget         @relation(fields: [budgetId], references: [id], onDelete: Cascade)
  category      BudgetCategory
  name          String?        // Display name (used for FINANCIAL_GOAL type)
  planned       Float
  actual        Float          @default(0)
  rollover      Float          @default(0)  // Rollover from this category
  notes         String?
  linkedGoalId  String?        // Optional link to a financial goal
  linkedGoal    FinancialGoal? @relation(fields: [linkedGoalId], references: [id], onDelete: SetNull)
  transactions  Transaction[]
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  @@unique([budgetId, category, linkedGoalId])
  @@index([linkedGoalId])
  @@map("budget_items")
}

enum BudgetCategory {
  RENT
  FOOD
  TRANSPORT
  SUBSCRIPTIONS
  UTILITIES
  HEALTHCARE
  ENTERTAINMENT
  SHOPPING
  MISCELLANEOUS
  FINANCIAL_GOAL  // Each financial goal becomes a budget item with this category
}

// ============== BUDGET TEMPLATE ==============

model BudgetTemplate {
  id          String               @id @default(uuid())
  userId      String               @unique
  user        User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  name        String               @default("My Budget Template")
  items       BudgetTemplateItem[]
  createdAt   DateTime             @default(now())
  updatedAt   DateTime             @updatedAt

  @@map("budget_templates")
}

model BudgetTemplateItem {
  id             String         @id @default(uuid())
  templateId     String
  template       BudgetTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  category       BudgetCategory
  plannedAmount  Float          @default(0)
  linkedGoalId   String?        // Optional link to a financial goal
  notes          String?
  order          Int            @default(0)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  @@unique([templateId, category, linkedGoalId])
  @@map("budget_template_items")
}

// ============== TRANSACTIONS ==============

model Transaction {
  id              String            @id @default(uuid())
  userId          String
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount          Float
  type            TransactionType
  description     String?
  source          String?           // Where money came from (e.g., "Salary", "Bank Account")
  destination     String?           // Where money went (e.g., "Groceries", "Emergency Fund")
  fromAccountId   String?           // Account money is coming from
  fromAccount     Account?          @relation("TransactionFrom", fields: [fromAccountId], references: [id], onDelete: SetNull)
  toAccountId     String?           // Account money is going to
  toAccount       Account?          @relation("TransactionTo", fields: [toAccountId], references: [id], onDelete: SetNull)
  budgetItemId    String?           // Link to budget item if spending
  budgetItem      BudgetItem?       @relation(fields: [budgetItemId], references: [id], onDelete: SetNull)
  financialGoalId String?           // Link to financial goal if contribution
  financialGoal   FinancialGoal?    @relation(fields: [financialGoalId], references: [id], onDelete: SetNull)
  date            DateTime          @default(now())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([userId, date])
  @@index([budgetItemId])
  @@index([financialGoalId])
  @@index([fromAccountId])
  @@index([toAccountId])
  @@map("transactions")
}

enum TransactionType {
  EXPENSE           // Money spent on budget category
  GOAL_CONTRIBUTION // Money added to financial goal
  INCOME            // Money received
  TRANSFER          // Transfer between accounts
}

// ============== CHART OF ACCOUNTS ==============

model Account {
  id              String        @id @default(uuid())
  userId          String
  user            User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  name            String
  type            AccountType
  balance         Float         @default(0)
  initialBalance  Float         @default(0)
  currency        Currency      @default(INR)
  institution     String?       // Bank name, wallet provider, etc.
  accountNumber   String?       // Last 4 digits or identifier
  color           String?       // For UI display
  icon            String?       // Icon identifier
  isActive        Boolean       @default(true)
  includeInTotal  Boolean       @default(true)  // Include in net worth calculation
  notes           String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt

  // Transaction relations
  transactionsFrom Transaction[] @relation("TransactionFrom")
  transactionsTo   Transaction[] @relation("TransactionTo")

  @@index([userId, isActive])
  @@map("accounts")
}

enum AccountType {
  CASH            // Physical cash
  BANK_ACCOUNT    // Savings/checking account
  CREDIT_CARD     // Credit card (liability)
  WALLET          // Digital wallet (PayTM, GPay, etc.)
  INVESTMENT      // Investment/brokerage account
  LOAN            // Loan (liability)
  OTHER
}

// ============== PROGRESS SNAPSHOTS ==============

model ProgressSnapshot {
  id            String   @id @default(uuid())
  userId        String
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date          DateTime @db.Date
  lifeScore     Int
  financeScore  Int
  fitnessScore  Int
  habitsScore   Int
  systemsScore  Int
  totalSaved    Float    @default(0)
  activeHabits  Int      @default(0)
  activeGoals   Int      @default(0)
  createdAt     DateTime @default(now())

  @@unique([userId, date])
  @@index([userId, date])
  @@map("progress_snapshots")
}

// ============== ACHIEVEMENTS ==============

model Achievement {
  id          String   @id @default(uuid())
  code        String   @unique  // e.g., "FIRST_GOAL", "STREAK_7"
  name        String
  description String
  icon        String
  category    AchievementCategory
  criteria    Json     // { type: "streak", value: 7 }
  points      Int      @default(10)
  createdAt   DateTime @default(now())

  // Relations
  userAchievements UserAchievement[]

  @@map("achievements")
}

model UserAchievement {
  id            String      @id @default(uuid())
  userId        String
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievementId String
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)
  unlockedAt    DateTime    @default(now())
  notified      Boolean     @default(false)

  @@unique([userId, achievementId])
  @@index([userId])
  @@map("user_achievements")
}

enum AchievementCategory {
  FINANCE
  FITNESS
  HABITS
  SYSTEMS
  GENERAL
}

// ============== GOAL TEMPLATES ==============

model GoalTemplate {
  id              String            @id @default(uuid())
  name            String
  description     String
  category        TemplateCategory
  type            String            // Maps to FinancialGoalType or FitnessMetricType
  defaultTarget   Float?
  defaultDuration Int?              // Days
  icon            String?
  isPublic        Boolean           @default(true)
  createdBy       String?           // User ID if user-created
  usageCount      Int               @default(0)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  @@index([category, isPublic])
  @@map("goal_templates")
}

enum TemplateCategory {
  FINANCIAL
  FITNESS
  HABIT
}

// ============== GOAL MILESTONES ==============

model GoalMilestone {
  id              String    @id @default(uuid())
  goalId          String
  goalType        String    // "FINANCIAL" or "FITNESS"
  name            String
  targetValue     Float
  isCompleted     Boolean   @default(false)
  completedAt     DateTime?
  order           Int       @default(0)
  createdAt       DateTime  @default(now())

  @@index([goalId, goalType])
  @@map("goal_milestones")
}

// ============== RECURRING CONTRIBUTIONS ==============

model RecurringContribution {
  id              String              @id @default(uuid())
  userId          String
  goalId          String
  goalType        String              // "FINANCIAL"
  amount          Float
  frequency       ContributionFrequency
  nextRunDate     DateTime
  lastRunDate     DateTime?
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  @@index([userId, isActive])
  @@index([nextRunDate, isActive])
  @@map("recurring_contributions")
}

enum ContributionFrequency {
  DAILY
  WEEKLY
  BIWEEKLY
  MONTHLY
}

// ============== JOURNAL ENTRIES ==============

model JournalEntry {
  id          String   @id @default(uuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date        DateTime @db.Date
  title       String?  // Optional title
  content     String
  gratitude   String?  // What are you grateful for
  mood        Int?     // 1-5 scale
  energy      Int?     // 1-5 energy level
  tags        String[] // Array of tags
  isPrivate   Boolean  @default(true)
  wordCount   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([userId, date])
  @@map("journal_entries")
}

// ============== USER PREFERENCES ==============

model UserPreferences {
  id                  String   @id @default(uuid())
  userId              String   @unique
  user                User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  theme               String   @default("light")  // "light", "dark", "system"
  language            String   @default("en")
  timezone            String   @default("UTC")
  weekStartsOn        Int      @default(0)        // 0 = Sunday, 1 = Monday
  emailNotifications  Boolean  @default(true)
  pushNotifications   Boolean  @default(true)
  habitReminders      Boolean  @default(true)
  reminderTime        String   @default("20:00")  // HH:MM format
  dashboardLayout     Json?    // Custom widget layout
  streakFreezeCount   Int      @default(0)        // Available streak freezes
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("user_preferences")
}

